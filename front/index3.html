<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chenillard Project</title>
    <link rel="stylesheet" ></link>
    
    <script>
        //Create WebSocket connection
        const socket = new WebSocket('ws://localhost:8080')

        //Connection opened
        socket.addEventListener('open', (event) => {
            socket.send(JSON.stringify('hello server!!'))
        })

        //Listen for messages
        socket.addEventListener('message', (event) => {
            console.log('Message from server : ' + event.data)

        })

        const sendMessage = () => {
            socket.send('Hello from client')
        }

    </script>
</head>

<body>
    <div id="ProgressBar2"></div>
    <div class="center_div">
        <p style="margin-top: 10px;">Click on to change states !</p>

        <table>
            <tr>
                <td><img id="led1" class="led" src="images/led-blue"></td>
                <td><img id="led2" class="led" src="images/led-blue"></td>
                <td><img id="led3" class="led" src="images/led-blue"></td>
                <td><img id="led4" class="led" src="images/led-blue"></td>
                <td><img id="led5" class="led" src="images/led-blue"></td>
            </tr>
        </table>

        <input type="range" min="0" max ="100" value="50" id="slider">

       
        <div id="SelectBtn"></div>
        
        <div id="SelectValue"></div>

        <p>Slide to change speed !</p>
        <div id="PowerOff"></div>
        <table id="tab_motif">
            <tr>
                <td id="btnStartChen" class="motif">Démarer Chenillard</td>
                <td id="btnChangeChen" class="motif">Changer sens</td>
                <td id="btnLEDsAleatoires" class="motif">Mode Aléatoire</td>
                <td id="btnColorAlea" class="motif">Couleurs aléatoires</td>
            </tr>
        </table>
    </div>   
    <script>
        window.onload = function () {
            installEventsOnMyFuckingTable();
            console.log(slider.value);
        }

        function sleep (time) { // sleep ms
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        var slider = document.getElementById("slider");
        var SelectBtn = document.getElementById("SelectBtn");
        var SelectValue = document.getElementById("SelectValue");
        var PowerOff = document.getElementById("PowerOff");
        var ProgressBar2 = document.getElementById("ProgressBar2");

        var chenille_On;
        var leftToRight;
        var ledIndice;
        var startingChenille;
        var alea;
        var colorAlea;
        var minSpeedChenille = 2000; // 2000 ms
        var maxSpeedChenille = 50; // 50 ms

        var led1 = document.getElementById("led1");
        var led2 = document.getElementById("led2");
        var led3 = document.getElementById("led3");
        var led4 = document.getElementById("led4");
        var led5 = document.getElementById("led5");
        var tabLeds = [led1, led2, led3, led4, led5] 

        var btnstartChen = document.getElementById('btnStartChen')
        var btnChangeChen = document.getElementById('btnChangeChen')
        var btnLEDsAleatoires = document.getElementById('btnLEDsAleatoires')
        var btnColorAlea = document.getElementById('btnColorAlea')
        
        SelectValue.innerHTML = slider.value;
        ProgressBar2.style.width = slider.value + "%";

        function init(){
            let position = 0.44 *slider.value +25
            SelectBtn.style.left = position + "%"
            SelectValue.style.left = position + "%"
            initialisation = false
        }

        slider.oninput = function(){
            //slider.style.left = slider.value + "%";
            SelectValue.innerHTML = slider.value;
            ProgressBar2.style.width = slider.value + "%";
            SelectBtn.style.position = slider.style.position
            let position = 0.44 *slider.value +25 
            SelectBtn.style.left = position + "%"
            SelectValue.style.left = position + "%"
        }

        function randomLED(){
            return Math.floor(Math.random() * 5);
        }

        function colorLED(ledIndice){
            switch(ledIndice){
                case 0 : 
                    return "images/led-orange";
                case 1 : 
                    return "images/led-red";
                case 2 : 
                    return "images/led-yellow";
                case 3 : 
                    return "images/led-green";
            }
        }

        function reset_leds(){
            tabLeds.forEach(elem_led => elem_led.src = "images/led-blue") //remet toutes les LEDs à l'état initial = bleu
        }

        function reset_chenille(){
            reset_leds();
            chenille_On = false;
            ledIndice = 0;
            startingChenille = false;
            alea = false;
            colorAlea = false;
        }

        PowerOff.onclick = function(){
            reset_chenille();
        }

        btnstartChen.onclick = function(){
            reset_chenille();
            chenille_On = true;
            ledIndice = 0;
            startingChenille = true;
            leftToRight = true;
            alea = false;
            chenille();
        }

        btnChangeChen.onclick = function(){
            reset_chenille();
            chenille_On = true;
            ledIndice = 4;
            startingChenille = true;
            leftToRight = false;
            alea = false;
            chenille();
        }

        btnLEDsAleatoires.onclick = function(){
            reset_chenille();
            chenille_On = true;
            ledIndice = randomLED();
            startingChenille = true;
            leftToRight = false;
            alea = true;
            chenille();
        }

        btnColorAlea.onclick = function(){
            //reset_chenille();
            colorAlea = true;
        }

        //MON ESSAI DE CHENILLARD / RECURSIVITE
        function chenille(){
            if(startingChenille){ // partie de code un peu sale pour gérer une bizarrerie à la 1ère incrémentation au lancement
                reset_leds();
                if(colorAlea == true){
                    tabLeds[ledIndice].src = colorLED(Math.floor(Math.random() * 4));
                } else {
                    tabLeds[ledIndice].src = "images/led-orange";// = 0 si leftToRight, 4 si rightToLeft, <=4 et >=0 si aleatoire
                }
                if(alea == true){
                    ledIndice = randomLED();
                    //ledIndice = Math.floor(Math.random() * 4);
                } else {
                    if(leftToRight == true){
                        ledIndice +=1;
                    } else {
                        ledIndice -=1;
                    }
                }
                startingChenille = false;
                var start = new Date().getTime();
                while (new Date().getTime() < start + 500);
            }
            //motif4.innerHTML = ledIndice;
            sleep(((maxSpeedChenille-minSpeedChenille)/100)*slider.value + 2000).then(() => { //max speed = 50 ms / min speed = 2000 ms / fonction affine
                if(chenille_On == true){
                    
                    if(colorAlea == true){
                        tabLeds[ledIndice].src = colorLED(Math.floor(Math.random() * 4));
                    } else {
                        reset_leds();
                        tabLeds[ledIndice].src = "images/led-orange";// = 0 si leftToRight, 4 si rightToLeft, <=4 et >=0 si aleatoire
                    }
                    if(alea == true){
                        ledIndice = randomLED();
                        //ledIndice = Math.floor(Math.random() * 4);
                    } else {
                        if(leftToRight == true){
                            ledIndice += 1;
                            if(ledIndice > 4){
                                ledIndice = 0;
                            }
                        } else {
                            ledIndice -= 1;
                            if(ledIndice < 0){
                                ledIndice = 4;
                            }
                        }
                    }
                    return chenille();
                }
                else; // si chenille_On == false // pas de chenillard;
            })
        }

        var initialisation = true
        function installEventsOnMyFuckingTable(){
            if(initialisation){
                init()
            }
        
            var table = document.getElementsByTagName('table')[0]; // ou getElementById()
            var tbody = table.getElementsByTagName('tbody')[0];
            var _td = tbody.getElementsByTagName('td');
         
            for (let i=0 ; i<_td.length ; i++) {
                _td[i].onclick = () => {
                    if(chenille_On == true){
                        reset_chenille();
                    }
                    let elem = i + 1
                    switch(document.getElementById("led"+elem).src){
                        case "http://a6fa-148-60-99-14.ngrok.io/images/led-orange" :
                            document.getElementById("led"+elem).src = "images/led-blue"   
                            socket.send(JSON.stringify({led: elem, state: "blue"}))                    
                        break
                        case "http://a6fa-148-60-99-14.ngrok.io/images/led-blue" :
                            document.getElementById("led"+elem).src = "images/led-orange"                      
                            socket.send(JSON.stringify({led: elem, state: "orange"}))
                        break
                        default :
                            document.getElementById("led"+elem).src = "images/led-blue"
                            socket.send(JSON.stringify({led: elem, state: "blue"}))
                    }
                }
            }
        }        
    </script> 
    <style>
        body{
            background-color: #1a1a1a;
            color: #fff;
            font-family: system-ui;
            position: relative;
            letter-spacing: 2px;
            text-align: center;
        }

        .center-div{
            margin : 0 auto;
            width: max-content;
            text-align: center;
            position: relative;
        }

        table{
            table-layout: fixed;
            border-collapse: collapse;
            margin: 0 auto;
        }

        td{
            text-align: center;
        }

        .led{
            width: 75%;
            cursor: pointer;
        }
        
        input[type=range]{
            -webkit-appearance: none;
            margin-top: 30px;
            width: 45%;
            height: 9px;
            background-color: #ddd;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb{
            -webkit-appearance: none;
            /*background: #c5c881;/* url(images/btn-icon);*/
            background-image: url(images/btn-icon);
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            border: #fff;
        }
        input[type=range]::-ms-track{
            width: 60%;
            cursor: pointer;
        }
        input[type=range]:focus{
            outline: none;
        }
        input[type=range]:focus::-webkit-slider-runnable-track{
            background: none;
        }
        input[type=range]::-ms-fill-lower{
            background: rgb(178, 26, 26);
        }

        #SelectBtn{
            background-image: url(images/btn-icon);
            height: 20px;
            width: 20px;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            bottom: 20px;
            margin-left: 7.3px;
        }

        #SelectValue{
            width: 33px;
            height: 28px;
            position: relative;
            top: 0;
            background: #ffd200;
            border-radius: 5px;
            text-align: center;
            line-height: 30px;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 0px;
        }

        #SelectValue::after{
            content: '';
            border-bottom: 17px solid #ffd200;
            border-left: 17px solid #1a1a1a;
            border-right: 16px solid #1a1a1a;
            position: absolute;
            top: -13px;
            left:0;
        }

        #PowerOff{
            height: 30px;
            width: 30px;
            background-image: url(images/poweroff);
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            margin: 0 auto;
            z-index: 2;
        }

        #tab_motif{
            width: 50%;
            border-collapse: separate;
            border-spacing: 60px;
            position: relative;
            margin-top: -40px;
        }

        .motif{
            height: 100px;
            width: 80px;
            cursor: pointer;
            background-color: rgb(40, 40, 103);
            border-radius: 20%;
            color: #ecfd29;
            letter-spacing: 1px;
        }

        #ProgressBar2{
            width: 100%;
            height: 9px;
            background-color: rgb(40, 40, 103);
            top: 0;
            left: 0;
            border-radius: 5px;
            position: sticky;
        }
    </style>
</body>
</html>